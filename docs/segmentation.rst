Сегментация
==============

Для обучения полноценного ИИ не хватает 1000 изображений, а вручную маркировать 6000-7000 слишком сложно. Поэтому дальнейшая обработка будет производиться с помощью модели. Мы создадим и обучим ее в Google Colab. Код лежит в github репозитории **"code/Segmentation.ipynb"**.

Для удобства, блоки кода пронумерованы (рис. 11):

.. figure:: pictures/нумерация.png
       :scale: 60 %
       :align: center
       :alt: alternate text

       рис.11

.. hint:: Некоторые блоки кода даны с результатами их работы. Ориентируйтес на них, как на индикатор правильности работы.

Подготовка
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Если не хотите переживать о файловых путях, создайте аналогичную структуру в корневой папке google drive:

.. figure:: pictures/Дерево_1.png
       :scale: 100 %
       :align: center
       :alt: alternate text

       Структура файлов

Загрузите кадры вашего набора данных в папку: **VisionProject/Dataset/Data/** Затем загрузите файл **"Labels.json"**, который у вас был после разметки кадров шагов. **"NewLabels"** может не существовать вовсе, либо быть копией **"Labels"**
Так же заливаем видео, которые послужат исходным материалом для новых размеченных кадров (Лучше сделать это сейчас, но если что - можно и потом). Их советую подгружать в папку **VisionProject/Videos**.

Вы можете использовать свою собственную структуру, если хотите, но вам придется изменить **пути к файлам** (Подробнее здесь: :ref:`mainfails`)

**Обязательно скопируйте** google collab из **"code/Segmentation.ipynb"** на свой google drive.

.. attention:: Collab должен лежать **вне** папки **VisionProject**

.. _studyseg:

Обучение модели (сегментация)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Процесс обучения модели происходит в блоках с **#1** по **#13**. Если вы правильно выполнили предыдущие шаги, вам остается только запускать блоки кода один за другим. Потребуется только одно дополнительные действие: в блоке **#3** отребуется дать разрешение на подключение к гугл диску (рис 12).

.. figure:: pictures/разрешение.png
       :scale: 80 %
       :align: center
       :alt: alternate text

       Запрос на разрешение

Если что-то пошло не так, обращайтесь вот сюда: :ref:`mainfailinf`, сюда :ref:`segmentationpaths` или сюда :ref:`basecomm`.

Обучение может длится порядка **3-6 часов**, в зависимости от стабильности интернета и объема исходного датасета.

.. attention:: На протяжение всего времени обучения вам необходимо быть непосредственно вблизи работающего колаба, так как во избежания использования ботами, при длительном бездействии пользователя колаб просит **пройти капчу**. Если вы не успеваете среагировать, весь прогресс **сбрасывается**.

Разметка новых кадров
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Разметка новых кадров начинается с блока **#14** и идет до конца.
Напомнаю, что видео лежат в папке **VisionProject/Videos/** (Если вы не залили их раньше - самое время это исправить). Внесите названия в блок **#15** (Можно ставить сколько угодно вызовов функций, главное не забывайте менять названия видео).

**Пример**
Для видео с названием **video1** строка кода, отвечающая за подключение будет выглядеть как:
::

    get_frames('/content/drive/MyDrive/VisionProject/Videos/video1.mp4', './videos/')

Далее продолжаем последовательно выполнять блоки.

.. attention:: Разметка может длится несколько часов, и вам так же необходимо следить за работой колаба.

.. hint:: Блоки с **#33** по **#37** нужны для визуальной тестировки результата. Их можно пропустить.

Получение готового датасета
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
По окончании выполнения всех блоков неархивированный полученный датасет будет загружен в папку **VisionProject/NewDataset/Data/**, архивиованный: **VisionProject/NewDataset/dataset.zip**, аннотации к нему будут лежать в файле **VisionProject/NewDataset/NewLabels**.


Чистка данных
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Полученный датасет и аннотации к нему следует скачать, открыть в RemoApp и просмотреть на предмет неправильной или неточной разметки. Неподходящие по стандартам фото следует удалять или переразмечать вручную. Пример правильно размеченного маркера есть в разделе :ref:`wellmarked`.

Файл с "чистыми" аннотациями следует назвать **CleanedNewLabels.json** и подгрузить в папку **VisionProject/NewDataset/**. Набор кадров (**/NewDataset/Data/**) можно оставить неронутым или - если в вас говорит перфекционизм - залить "очищенный".
